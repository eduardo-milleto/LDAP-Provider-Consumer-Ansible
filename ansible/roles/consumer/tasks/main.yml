# Template dos arquivos do "consumer"

- name: Dar template no arquivo "consumer.ldif"
  ansible.builtin.template:
    src: templates/consumer.ldif.j2
    dest: /tmp/ufrgs-openldap/templates/consumer.ldif
    owner: root
    group: wheel
    mode: '0644'
  become: true
  become_user: root

# Adição dos arquivos do consumer

- name: Verificar se a configuração de "módulos" já existe
  command: ldapsearch -x -LLL -D 'cn=admin,cn=config' -w '{{ ldap_user_pass }}' -H ldapi:/// -b 'cn=config' '(cn=module{1})' 
  register: ldap_modules_check
  become: true
  become_user: root

- name: Importar o arquivo "provider_active_modules.ldif" - habilita os módulos
  shell: "ldapadd -Y EXTERNAL -H ldapi:/// -f /tmp/ufrgs-openldap/files_configuration/provider-active-modules.ldif"
  when: ldap_modules_check.stdout == ""
  become: true
  become_user: root

- name: Verificar se a configuração de "módulos" já existe
  command: ldapsearch -x -LLL -D 'cn=admin,cn=config' -w '{{ ldap_user_pass }}' -H ldapi:/// -b 'cn=config' '(cn=module{1})' 
  register: ldap_modules_check
  become: true
  become_user: root

- name: Importar o arquivo "consumer.ldif"
  command: ldapadd -Y EXTERNAL -H ldapi:/// -f /tmp/ufrgs-openldap/templates/consumer.ldif
  become: true
  become_user: root

  # Excluir pasta-mãe dos arquivos de instalação LDAP

- name: Remover pasta-mãe dos arquivos de instalação LDAP
  ansible.builtin.file:
    path: /tmp/ufrgs-openldap
    state: absent
  become: true
  become_user: root
